beta: true
category: Forensics & Malware Analysis
commonfields:
  id: Symantec Blue Coat Content and Malware Analysis
  version: -1
configuration:
- defaultvalue: ""
  display: Server URL
  name: url
  required: true
  type: 0
- defaultvalue: ""
  display: API Key
  name: api_key
  required: true
  type: 4
- defaultvalue: "False"
  display: Use system proxy settings
  name: proxy
  required: false
  type: 8
- defaultvalue: ""
  display: Trust any certificate (not secure)
  name: insecure
  required: false
  type: 8
- defaultvalue: "300"
  display: 'Max. Polling Time (in seconds):'
  name: maxpolls
  required: false
  type: 0
- defaultvalue: ""
  display: Verbose (show log in case of error)
  name: verbose
  required: false
  type: 8
- defaultvalue: ""
  display: Environment Images (sbx or ivm or drd)
  name: environment
  required: false
  type: 0
description: Symantec Blue Coat Content and Malware Analysis integration.
detaileddescription: 'Note: This is a beta Integration, which lets you implement and
  test pre-release software. Since the integration is beta, it might contain bugs.
  Updates to the integration during the beta phase might include non-backward compatible
  features. We appreciate your feedback on the quality and usability of the integration
  to help us identify issues, fix them, and continually improve.'
display: Symantec Blue Coat Content and Malware Analysis (Beta)
image: data:image/png;base64,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
name: Symantec Blue Coat Content and Malware Analysis
script:
  commands:
  - arguments:
    - description: The URL to upload.
      name: url
      required: true
    description: Submit a URL for analysis.
    name: symantec-cma-upload-url
  - arguments:
    - description: The file entry to analyze.
      name: file_id
    description: Submit a file for analysis.
    name: symantec-cma-upload-file
  - arguments:
    - description: The task ID.
      name: task_id
      required: true
    description: Retrieves an analysis report.
    name: symantec-cma-get-report
  dockerimage: demisto/python3:3.7.5.4002
  runonce: false
  script: |
    import shutil
    import urllib3


    # disable insecure warnings
    urllib3.disable_warnings()

    BASE_URL = demisto.params()['url']
    USE_SSL = not demisto.params().get('insecure', False)


    def http_request(url_suffix, data=None, files=None, parse_json=True):
        """
        Generic request to BlueCoat Malware Analysis
        """
        data = {} if data is None else data
        url_params = {}  # type:dict
        full_url = BASE_URL + url_suffix
        api_key = demisto.params().get('api_key', False)
        headers = {'X-API-TOKEN': api_key}

        try:
            if files:
                result = requests.post(full_url, verify=USE_SSL, headers=headers, params=url_params,
                                       data=data, files=files)
            else:
                result = requests.get(full_url, verify=USE_SSL, headers=headers, params=url_params)
            if result.status_code == 200:
                if parse_json:
                    return result.json()
                return result.content
            if result.status_code == 404:
                raise Exception('Resource Not Available or Does not Exist')
            demisto.debug(f'result is: {result.text}')
            raise Exception(f'Your request failed with the following error: {result.reason}.\n{result.text}')

        except requests.exceptions.ConnectTimeout as exception:
            err_msg = 'Connection Timeout Error - potential reasons might be that the Server URL parameter' \
                      ' is incorrect or that the Server is not accessible from your host.'
            raise DemistoException(err_msg, exception)
        except requests.exceptions.SSLError as exception:
            err_msg = 'SSL Certificate Verification Failed - try selecting \'Trust any certificate\' checkbox in' \
                      ' the integration configuration.'
            raise DemistoException(err_msg, exception)
        except requests.exceptions.ProxyError as exception:
            err_msg = 'Proxy Error - if the \'Use system proxy\' checkbox in the integration configuration is' \
                      ' selected, try clearing the checkbox.'
            raise DemistoException(err_msg, exception)
        except Exception as exception:
            raise Exception(str(exception))


    def url_analysis_to_entry(title, analysis):
        """
        Args:
            title: entry title
            analysis: url analysis data

        Returns:
            an entry
        """
        context = []
        table = []
        dbot_scores = []

        analysis_info = {
            'ID': analysis['id'],  # for detonate generic polling
            'SampleName': analysis['results']['metadata']['sample']['label'].replace("hxxp", "http"),
            'Time': analysis['results']['metadata']['sample']['date_added'],
            'URL': analysis['results']['metadata']['sample']['url'],
            'Score': analysis['results']['summary']['risk_score'],
            'Result': analysis['results']['summary'],
            'status': 'done'
        }
        risk_score = analysis['results']['summary']['risk_score']
        analysis_context = dict(analysis_info)
        analysis_table = dict(analysis_info)
        malicious = None
        suspicious = None

        if risk_score > 9:
            dbot_score = 3
            malicious = {
                'Vendor': 'Symantec Content and Malware Analysis',
                'SHA256': analysis['results']['metadata']['sample']['hashes']['sha256'],
            }
        elif 7 < risk_score < 9:
            dbot_score = 2
            malicious = {
                'Vendor': 'Symantec Content and Malware Analysis',
                'SHA256': analysis['results']['metadata']['sample']['hashes']['sha256'],
            }
            suspicious = True
        else:
            dbot_score = 1

        dbot_scores.append({
            'Vendor': 'Symantec Content and Malware Analysis',
            'Indicator': analysis['results']['metadata']['sample']['label'].replace("hxxp", "http"),
            'Type': 'url',
            'Score': dbot_score,
            'Malicious': malicious,
            'Suspicious': suspicious
        })
        context.append(analysis_context)
        table.append(analysis_table)

        entry = {
            'ContentsFormat': formats['json'],
            'Type': entryTypes['note'],
            'Contents': context,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown(title, table, removeNull=True),
            'EntryContext': {'Symantec.Analysis(val.ID && val.ID == obj.ID)': createContext(context, removeNull=True),
                             'DBotScore':
                                 createContext(dbot_scores, removeNull=True),
                             }
        }

        return entry


    def file_analysis_to_entry(title, analysis):
        """
        Args:
            title: entry title
            analysis: file analysis data

        Returns:
            an entry
        """
        context = []
        table = []
        dbot_scores = []

        analysis_info = {
            'ID': analysis['id'],  # for detonate generic polling
            'SampleName': analysis['results']['metadata']['sample']['label'],
            'Time': analysis['results']['metadata']['sample']['date_added'],
            'MD5': analysis['results']['metadata']['sample']['hashes']['md5'],
            'SHA256': analysis['results']['metadata']['sample']['hashes']['sha256'],
            'Score': analysis['results']['summary']['risk_score'],
            'Result': analysis['results']['summary'],
            'status': 'done'
        }

        risk_score = analysis['results']['summary']['risk_score']
        analysis_context = dict(analysis_info)
        analysis_table = dict(analysis_info)
        malicious = None
        suspicious = None

        if risk_score > 9:
            dbot_score = 3
            malicious = {
                'Vendor': 'Symantec Content and Malware Analysis',
                'SHA256': analysis['results']['metadata']['sample']['hashes']['md5'],
            }
        elif 7 < risk_score < 9:
            dbot_score = 2
            malicious = {
                'Vendor': 'Symantec Content and Malware Analysis',
                'SHA256': analysis['results']['metadata']['sample']['hashes']['md5'],
            }
            suspicious = True
        else:
            dbot_score = 1

        dbot_scores.append({
            'Vendor': 'Symantec Content and Malware Analysis',
            'Indicator': analysis['results']['metadata']['sample']['hashes']['md5'],
            'Type': 'file',
            'Score': dbot_score,
            'Malicious': malicious,
            'Suspicious': suspicious
        })
        context.append(analysis_context)
        table.append(analysis_table)

        entry = {
            'ContentsFormat': formats['json'],
            'Type': entryTypes['note'],
            'Contents': context,
            'ReadableContentsFormat': formats['markdown'],
            'HumanReadable': tableToMarkdown(title, table, removeNull=True),
            'EntryContext': {'Symantec.Analysis(val.ID && val.ID == obj.ID)': createContext(context, removeNull=True),
                             'DBotScore':
                                 createContext(dbot_scores[0], removeNull=True),
                             }
        }
        return entry


    def create_task(sample_id):
        """
        Args:
            sample_id: smaple id for the url

        Returns:
            the task data
        """
        files = {'sample_id': str(sample_id), 'env': demisto.params()['environment']}
        new_task = http_request('/rapi/tasks', data=files, files=files)
        return new_task


    def upload_url(url):
        """
        Args:
            url: url to upload

        Returns:
            an entry
        """
        res = http_request('/rapi/samples/url', data={'url': url}, files={'url': url})
        sample_id = res['results'][0]['samples_url_sample_id']

        if sample_id == 0:
            raise Exception('Unable to upload file to Symantec Content Analysis - no sample id was returned')

        task_details = create_task(sample_id)['results'][0]
        samples_label = task_details['samples_label']
        samples_owner = task_details['samples_owner']
        samples_sample_id = task_details['samples_sample_id']
        tasks_task_id = task_details['tasks_task_id']
        detonate_result = {'Label': samples_label, 'Owner': samples_owner, 'Sample ID': samples_sample_id,
                           'ID': tasks_task_id, 'status': 'submitted'}
        return {
            'Type': entryTypes['note'],
            'Contents': task_details,
            'ContentsFormat': formats['json'],
            'HumanReadable': tableToMarkdown('Symantec URL Detonation', [detonate_result]),
            'ReadableContentsFormat': formats['markdown'],
            'EntryContext': {'Symantec.Analysis(val.ID && val.ID == obj.ID)': detonate_result}
        }


    def upload_file(file_entry):
        """
        Args:
            file_entry: entry_id of the file to upload

        Returns:
            an entry
        """
        shutil.copy(demisto.getFilePath(file_entry)['path'],
                    demisto.getFilePath(file_entry)['name'])

        with open(demisto.getFilePath(file_entry)['name'], 'rb') as file:
            result = http_request('/rapi/samples/basic', data={}, files={'file': file})

        shutil.rmtree(demisto.getFilePath(file_entry)['name'], ignore_errors=True)

        sample_id = result['results'][0]['samples_basic_sample_id']
        if sample_id == 0:
            raise Exception('Unable to upload file to Symantec Content Analysis - no sample id was returned')

        task_details = create_task(sample_id)['results'][0]
        samples_label = task_details['samples_label']
        samples_owner = task_details['samples_owner']
        samples_sample_id = task_details['samples_sample_id']
        tasks_task_id = task_details['tasks_task_id']
        detonate_result = {'Label': samples_label.replace("hxxp", "http"), 'Owner': samples_owner,
                           'Sample ID': samples_sample_id, 'ID': tasks_task_id, 'status': 'submitted'}
        return {
            'Type': entryTypes['note'],
            'Contents': task_details,
            'ContentsFormat': formats['json'],
            'HumanReadable': tableToMarkdown('Symantec File Detonation', [detonate_result]),
            'ReadableContentsFormat': formats['markdown'],
            'EntryContext': {'Symantec.Analysis(val.ID && val.ID == obj.ID)': detonate_result}
        }


    def get_report(task_id):
        """
        Args:
            task_id: task_id to retrieve the report upon

        Returns:
            Report data for a given task_id
        """
        report = http_request(f'/rapi/search/report/{str(task_id)}', data={}, files={})
        if 'Entry' not in report:
            report['id'] = int(task_id)
            if 'sample_type' in report['results']['metadata']['sample']:
                if report['results']['metadata']['sample']['sample_type'] == 'url':
                    return url_analysis_to_entry('URL Detonation Report', report)
                return file_analysis_to_entry('File Detonation Report', report)
        else:
            return {
                'Type': entryTypes['note'],
                'Contents': {},
                'ContentsFormat': formats['json'],
                'HumanReadable': "Scan in  pending or does not exist",
                'ReadableContentsFormat': formats['markdown'],
                'EntryContext': {'Symantec.Analysis(val.ID && val.ID == obj.ID)': {
                    'ID': task_id, 'status': 'pending/does_not_exist'}}
            }


    def main():
        """
        EXECUTE INTEGRATION PARAM
        """
        try:
            command = demisto.command()
            LOG(f'command is {command}')
            handle_proxy()
            if command == 'test-module':
                demisto.results('ok')
            elif command == 'symantec-cma-upload-file':
                demisto.results(upload_file(demisto.args()['file_id']))
            elif command == 'symantec-cma-upload-url':
                demisto.results(upload_url(demisto.args()['url']))
            elif command == 'symantec-cma-get-report':
                demisto.results(get_report(demisto.args()['task_id']))
            else:
                raise NotImplementedError(f'Command "{command}" is not implemented.')

        except Exception as err:
            return_error(f'An error has occurred in the Symantec Blue Coat Malware Analysis integration: {str(err)}')


    if __name__ in ['__main__', 'builtin', 'builtins']:
        main()
  subtype: python3
  type: python
system: true
